script "behavior_view_SivaSivaBrowser"# this behavior is also use  by the view_BrowserLandscape.livecode stack# local sMediaURL,sBrowserURL,sBrowserOrientationlocal sPortraitRect, sLandscapeRect, sScreenRect,local  sHackDownloadCompleteFlag# this stack intend to make the UI responsive# by getting rect of the screen and using those coordinator# to set the stack size and UI size.# setBrowserURL  # is sent from portal_GoURL in the lib_SivaSivaPortal on preopenstack   lock screen   put the short name this stack into theBrowser   if theBrowser contains "landscape" then      put "landscape" into sBrowserOrientation   else       # regular brower stack supports orientation changes      # but always starts out in portrait mode      put "portrait" into sBrowserOrientation    end if   if isMobile() then      if sBrowserOrientation = "landscape"   then         mobileSetAllowedOrientations "landscape left,landscape right"      else         mobileSetAllowedOrientations "portrait,landscape left,landscape right"      end if   end if   resetUI   send "updateUI sBrowserOrientation"  to this card in 0 secondsend preopenstackon opencard   set the acceleratedRendering of this stack to true     --send "updateUI sBrowserOrientation" to this card in 20 millisecondsend opencardon resizeStack   if isMobile() then      if sBrowserOrientation = "landscape" then         send "updateUI sBrowserOrientation" to this card in 100 milliseconds           else         put mobileDeviceOrientation() into theOrientation         send "updateUI" && theOrientation to this card in 100 milliseconds       end if      end if   end resizeStackcommand updateUI theOrientation      put the long id of widget "body" of card "SivaSivaBrowser" into tBrowser   put the long id of widget "loader" of card "SivaSivaBrowser" into tLoader   switch       case (theOrientation contains "portrait")         put the width of this card into sCdWidth         put the height of this card into sCdHeight         put (sCdWidth/2,(sCdHeight-50)/2) into tBrowserLoc         put (0,0,sCdWidth,(sCdHeight - 50)) into tBrowserRect         set the rect of tBrowser  to tBrowserRect         set the loc of tBrowser to tBrowserLoc         set the rect of tLoader to tBrowserRect         set the loc of tLoader to tBrowserLoc         set loc group "footer" of card "SivaSivaBrowser" to ( round(sCdWidth/2),sCdHeight - 25)         put sCdWidth/4 into tUnit         set the loc of widget "go-home-portal" of card "SivaSivaBrowser" to (tUnit/2,sCdHeight-25)         set the loc of widget "add-favorites" of card "SivaSivaBrowser" to (tUnit*1.5,sCdHeight-25)         set the loc of widget "share"  of card "SivaSivaBrowser" to (tUnit*2.5,sCdHeight-25)         set the loc of widget "settings-gear" of card "SivaSivaBrowser" to (tUnit*3.5,sCdHeight-25)         show group "footer" of card "SivaSivaBrowser"         break       case (theOrientation contains "landscape")         put the width of this card into sCdWidth         put the height of this card into sCdHeight         hide group "footer" of card "SivaSivaBrowser"                  put (0,0,(sCdwidth- 50),sCdHeight) into tBrowserRect         put ((sCdWidth+50)/2,sCdHeight/2) into tBrowserLoc                           set the rect of tBrowser  to tBrowserRect         set the rect of tLoader to tBrowserRect         set the loc of tBrowser to  tBrowserLoc         set the loc of tLoader to  tBrowserLoc                  set loc group "footer" of card "SivaSivaBrowser" to ( 25,sCdHeight/2)         put sCdHeight/4 into tUnit         set the loc of widget "go-home-portal" of card "SivaSivaBrowser" to (25,tUnit/2)          set the loc of widget "add-favorites" of card "SivaSivaBrowser" to (25,tUnit*1.5)         set the loc of widget "share"  of card "SivaSivaBrowser" to (25, tUnit*2.5)         set the loc of widget "settings-gear" of card "SivaSivaBrowser" to (25, tUnit*3.5)         show group "footer" of card "SivaSivaBrowser"            end switch      if (the lockscreen) then unlock screenend updateUIcommand setBrowserURL pURL   setJournalFlag (0)   set the url of widget "body" of cd "SivaSivaBrowser" to pURLend setBrowserURLcommand terminateBrowser      if not (the vis of widget "loader") then      journal_AddEntry   end if      --   hide widget "Body"   --   hide widget "loader"   --   set the url of widget "Body" to empty      if sBrowserOrientation = "landscape" then      portal_SetLastStack "view_BrowserLandscape"   else      portal_SetLastStack "view_SivaSivaBrowser"   end if   end terminateBrowserLocal sStartLoadTime,sTimePassed,sLoadSuccessFlag,# BUG iOS does not respond to message  "browserDocumentLoadBegin"# the loading Spinner and cancel command remain on screen.# it works on Android and desktop. This is needed in case the URL does load# and the user wants to break/leave the connection.# the "hack" is to add it the browserDocumentLoadComplete# this means is take a second so longer to appear on ios# than on Android# An Android we have a separate issue. # browserDocumentLoadComplete  is sent twice# and two entries are made the journal # because "journal_addEntry" is trigger two times# ( I assume because browserDocumentLoadComplete is fired twice?)# the first is triggeed outside the message path# and give "bogus" information to a jounal.sqlite record# The second one is inside the message path.    journal_AddEntry fires twice# and we get a correct record. Both records the appear the journal on Android# this does not happen on desktop and iOSon browserDocumentLoadBegin pURL   ntinfo ("begin load url , body is visible: "& (the vis of widget "body"))   set layer of widget "loader" to "top"   set htmltext of widget "Loader" to fld "loaderHTML"   show widget "loader"   show group "footer"   ntInfo ( (the lockscreen) & "; show the loader " &  pURL)end browserDocumentLoadBeginon browserDocumentLoadComplete pURL     ntinfo ("download flag: " & sHackDownloadCompleteFlag)   if pURL is not empty then      dispatch "hideloader" to me    end if   show widget "Body"   show group "footer"   put "true" into sLoadSuccessFlag   put pURL into sBrowserURL   browser_SetLastURL pURL   put short name of the target into tBrowser      ntInfo ( (the lockscreen) & "; show the target: " & tBrowser &"; " &  pURL)   end browserDocumentLoadCompletecommand hideLoader   hide widget "loader"end hideLoaderon journal_AddEntry   try      parseTheHTML (the htmlText of widget "body"),"Title"   end try   put browser_GetLastURL() into pData["weburl"]    put browser_GetLastPageTitle() into tTitle   if sBrowserOrientation = "landscape" then      Journal_RecordEntry "view_BrowserLandscape",tTitle,pData        else      Journal_RecordEntry "view_SivaSivaBrowser",tTitle,pData      end if   end journal_AddEntryon journalResume  pDataA, pEntryA   put the long id of widget "Body" of cd "SivaSivaBrowser"  into tBrowser    set the URL of tBrowser to pDataA["weburl"]end journalResumecommand share_Items    put browser_GetLastURL() into tWebPage   put tWebPage into sShareItemsA["url"]     if tWebPage contains "Youtube" then # we have a video      put "Watch this Video!" into sShareItemsA["subject"]      put "Shared from the new SivaSiva App." into sShareItemsA["text"]   else      put "Check out this web page!" into sShareItemsA["subject"]      put "Shared from the SivaSiva App" into sShareItemsA["text"]   end if   return sShareItemsAend share_Itemscommand resetUI   set the url of  widget "body" of cd "SivaSivaBrowser" to empty   hide widget "body" of cd "SivaSivaBrowser"   show widget "loader" of cd "SivaSivaBrowser"end resetUIon closestack   if isMobile() then      mobileSetAllowedOrientations "portrait,portrait upside down"   end if   end closestack