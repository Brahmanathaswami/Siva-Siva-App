script "behavior_view_SivaSivaBrowser"local sMediaURL, sCardRect,sBrowserURLlocal sPortraitRect, sLandscapeRect, sScreenRect# this stack intend to make the UI responsive# by getting rect of the screen and using those coordinator# to set the stack size and UI size.--on opencard--   if the url of widget "body" of cd "SivaSivaBrowser" is empty then --      mobileSetAllowedOrientations "portrait,landscape left,landscape"--   end if--end opencard# setBrowserURL  # is sent from portal_GoURL in the lib_SivaSivaPortal on opencard   send "updateUI" to this card in 100 millisecondsend opencardcommand setBrowserURL pURL   set the url of widget "body" of cd "SivaSivaBrowser" to pURL   if isMobile() then      if pURL  contains "youtube.com" then         mobileSetAllowedOrientations "landscape left,landscape"      else         mobileSetAllowedOrientations "portrait,landscape left,landscape"      end if   end ifend setBrowserURLon resizeStack   updateUI end resizeStackcommand updateUI     --breakpoint    --   put the effective working screenRect into sScreenRect   --   put item 3 of sScreenRect into tWidth   --   put item 4 of sScreenRect - item 2 of sScreenRect into tHeight   put the long id of widget "body" of card "SivaSivaBrowser" into tBrowser   put the rect of card "SivaSivaBrowser" into sCardRect   put item 3 of sCardRect into tWidth   put item 4 of sCardRect - item 2 of sCardRect into tHeight   put the loc of card "SivaSivaBrowser"into tCardLoc   set the loc of widget "spinner"  of card "SivaSivaBrowser" to  tCardLoc   set the loc of fld "Cancel"  of card "SivaSivaBrowser" to (item 1 of tCardLoc, item 2 of tCardLoc-200)   put (0,0,tWidth,(tHeight - 50)) into tBrowserRect   set the rect of tBrowser  to tBrowserRect   set loc group "footer" of card "SivaSivaBrowser" to ( round(tWidth/2),tHeight - 25)   put tWidth/4 into tUnit   set the loc of widget "go-home-portal" of card "SivaSivaBrowser" to (tUnit/2,tHeight-25)   set the loc of widget "add-favorites" of card "SivaSivaBrowser" to (tUnit*1.5,tHeight-25)   set the loc of widget "share"  of card "SivaSivaBrowser" to (tUnit*2.5,tHeight-25)   set the loc of widget "settings-gear" of card "SivaSivaBrowser" to (tUnit*3.5,tHeight-25)end updateUIcommand terminateBrowser   hide field "Cancel"   hide widget "Spinner"   hide widget "Body"   set the url of widget "Body" to emptyend terminateBrowserLocal sStartLoadTime,sTimePassed,sLoadSuccessFlag,# BUG iOS does not respond to message  "browserDocumentLoadBegin"# the loading Spinner and cancel command remain on screen.# it works on Android and desktop. This is needed in case the URL does load# and the user wants to break/leave the connection.# the "hack" is to add it the browserDocumentLoadComplete# this means is take a second so longer to appear on ios# than on Android# An Android we have a separate issue. # browserDocumentLoadComplete  is sent twice# and two entries are made the journal # because "journal_addEntry" is trigger two times# ( I assume because browserDocumentLoadComplete is fired twice?)# the first is triggeed outside the message path# and give "bogus" information to a jounal.sqlite record# The second one is inside the message path.    journal_AddEntry fires twice# and we get a correct record. Both records the appear the journal on Android# this does not happen on desktop and iOSon browserDocumentLoadBegin pURL   hide field "cancel"    hide widget "Spinner"   show widget "Body"   show group "footer"end browserDocumentLoadBeginon browserDocumentLoadComplete pURL   hide field "cancel"    hide widget "Spinner"   show widget "Body"   show group "footer"   put "true" into sLoadSuccessFlag   put pURL into sBrowserURL   browser_SetLastURL pURL   if getJournalFlag() <> 1 then        journal_AddEntry   # trigger twice on android!   end if   setJournalFlag (0)end browserDocumentLoadCompleteon journal_AddEntry   try      parseTheHTML (the htmlText of widget "body"),"Title"   end try   put browser_GetLastURL() into pData["weburl"]    put browser_GetLastPageTitle() into tTitle   Journal_RecordEntry "view_SivaSivaBrowser",tTitle,pData   end journal_AddEntryon journalResume  pDataA, pEntryA      close stack "journal"   put "stack " && quote & pEntryA["module"] & quote into pDestination   portal_GoStack pDestination      put the long id of widget "Body" of cd "SivaSivaBrowser"  into tBrowser    set the URL of tBrowser to pDataA["weburl"]      # REVIEW: for now we assume we are going to the browser form LOOK    # which will be YouTube OR other Website both of which are on stack "portal"   # we get thus from URL   if pData["weburl"] contains "youtube" then # if is from Look      put "look" into tHomeLink   else      put "website" into tHomeLink   end if   put format ("card \"%s\" of stack \"Siva-Siva-Portal\"",tHomeLink) into tLastStack            portal_SetCurrentStack tLastStackend journalResumecommand share_Items    put browser_GetLastURL() into tWebPage   put tWebPage into sShareItemsA["url"]     if tWebPage contains "Youtube" then # we have a video      put "Watch this Video!" into sShareItemsA["subject"]      put "Shared from the new SivaSiva App." into sShareItemsA["text"]   else      put "Check out this web page!" into sShareItemsA["subject"]      put "Shared from the SivaSiva App" into sShareItemsA["text"]   end if   return sShareItemsAend share_Itemson closeStack   resetUIend closeStackcommand resetUI   set the url of  widget "body" of cd "SivaSivaBrowser" to empty   hide widget "body" of cd "SivaSivaBrowser"   show fld "Cancel" of cd "SivaSivaBrowser"   show widget "Spinner" of cd "SivaSivaBrowser"end resetUI